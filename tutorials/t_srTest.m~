% Compare the two different ways to generate low resolution image

%%
ieInit;

%% load the optical image
% path: /scratch/ZhengLyu/super_resolution_pbrt_scenes/optical_image/colorful.mat
inFile = fullfile('/scratch', 'ZhengLyu', 'super_resolution_pbrt_scenes',...
                                        'optical_image', 'colorful.mat');
                                    
load(inFile); % sceneWindow(scene);

%% Define the upscale factor
upscaleFactor = 3;
%% Create oi
oi = oiCreate;
oi = oiCompute(oi, scene);

%%

sensorlr = sensorCreate;
sensorlr = sensorSetSizeToFOV(sensorlr, oiGet(oi, 'fov'));

sensorhr = sensorSet(sensorlr, 'pixel size',...
                sensorGet(sensorlr, 'pixel size')/upscaleFactor);
sensorhr = sensorSet(sensorhr, 'size',...
                        sensorGet(sensorlr, 'size')*upscaleFactor);            
sensorlr = sensorCompute(sensorlr, oi);
sensorhr = sensorCompute(sensorhr, oi);

%%
ip = ipCreate;
iplr = ipCompute(ip, sensorlr);
iphr = ipCompute(ip, sensorhr);
%%
lrImg = ipGet(iplr, 'data srgb');
hrImg = ipGet(iphr, 'data srgb');
%%
vcNewGraphWin; 
subplot(1, 2, 1); imshow(lrImg); subplot(1, 2, 2); imshow(hrImg); 
%% see a crop of the low resolution image and high resolution image
rectlr = [90, 178, 20, 20];
lrCrop = imcrop(lrImg, rectlr); 

recthr = rectlr*upscaleFactor;
hrCrop = imcrop(hrImg, recthr); 

vcNewGraphWin; 
subplot(1, 2, 1); imshow(lrCrop); subplot(1, 2, 2); imshow(hrCrop); 

%%
wave = oiGet(oi, 'wave');
xyzValue = ieReadSpectra('XYZQuanta.mat', wave);
xyzfilter = xyzValue / max(max(max(xyzValue)));
sensorlr = sensorSet(sensorlr, 'noise flag', -1);
sensorhr = sensorSet(sensorhr, 'noise flag', -1);

xyzImglr = sensorComputeFullArray(sensorlr, oi, xyzfilter);
xyzImghr = sensorComputeFullArray(sensorhr, oi, xyzfilter);

%%
vcNewGraphWin; 
subplot(1, 2, 1); imshow(xyz2srgb(xyzImglr)); subplot(1, 2, 2); imshow(xyz2srgb(xyzImghr)); 
srgbImglr = xyz2srgb(xyzImglr);
srgbImghr = xyz2srgb(xyzImghr);
%% see a crop of the low resolution image and high resolution image
rectlr = [90, 178, 19, 19];
lrCrop = imcrop(xyzImglr, rectlr); 

recthr = [(rectlr(1)-1)*upscaleFactor+1, (rectlr(2)-1)*upscaleFactor+1, 59, 59];
hrCrop = imcrop(xyzImghr, recthr); 

vcNewGraphWin; 
subplot(1, 2, 1); imagesc(lrCrop);axis square; subplot(1, 2, 2); imagesc(hrCrop); axis square

%%
vcNewGraphWin; 
subplot(1, 2, 1); imagesc(lrCrop(:,:,1));axis square; subplot(1, 2, 2); imagesc(hrCrop(:,:,1)); axis square

%%
kernel = ones(3, 3, 3)/9;

rIdx = 1:upscaleFactor:size(srgbImghr,1);
cIdx = 1:upscaleFactor:size(srgbImghr,2);
lrConv = zeros(size(srgbImglr));
for rr = 1:length(rIdx)
    for cc = 1:length(cIdx)
        rSE = [rIdx(rr), rIdx(rr)+size(kernel,1)-1];
        cSE = [cIdx(cc), cIdx(cc)+size(kernel,2)-1];
        lrConv(rr, cc, :) = sum(sum(srgbImghr(rSE(1):rSE(2), cSE(1):cSE(2),:) .* kernel, 1),2);
    end
end
%%
vcNewGraphWin;
subplot(1, 2, 1); imagesc(lrCrop(:,:,1));axis square; subplot(1, 2, 2); imagesc(lrConv(:,:,1)); axis square

%%
vcNewGraphWin;
subplot(1, 3, 1); imshow(srgbImglr(:,:,1) - lrConv(:,:,1)); colorbar; caxis[1e-2];colormap('gray');
subplot(1, 3, 2); imshow(srgbImglr(:,:,2) - lrConv(:,:,2)); colorbar; colormap('gray');
subplot(1, 3, 3); imshow(srgbImglr(:,:,3) - lrConv(:,:,3)); colorbar; colormap('gray');